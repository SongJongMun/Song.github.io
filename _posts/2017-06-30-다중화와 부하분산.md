---
layout: post
title:  "다중화 / 부하분산"
categories: [Infra]
tags: [Infra]
description: 다중화, 부하분산
---

# 다중화/부하분산의 기본

## 1\. 다중화

장애가 발생해도 예비 운용장비로 시스템의 기능을 계속할 수 있도록 하는 것

### A. 다중화 단계

1. 장애 산정
    * 예) 라우터/서버 장애로 서비스 정지
2. 예비 운용장비 준비
    * Cold Standby
        * 평소에는 사용하지 않다가, 현재 운용장비에 장애 발생시 대체 투입
        * 운영 중 설정이 빈번하게 변경되지 않는 경우에 현실적으로 적합
        * 예) 라우터
    * Hot Standby
        * 두 대의 장비를 항상 가동시켜놓고 늘 같은 상태로 유지해야하는 경우에 적합
        * 주기적으로 현재의 운용장비 설정/내용을 예비 운용장비와 동기화
        * 예) 웹 서버
3. 운용체제 정비
    * 장애발생시 예비 운용장비로 교체
    * 장애 포인트별 장애 대응 구성

### B. VIP를 이용한 웹 서버 장애 대응

웹서버를 Active/Backup으로 구성하였을 경우, 현재 운용장비에 VIP를 할당하여 운용

* **VIP를 이용한 Active/Backup 구성** ![pic1.png](/files/1915147654540262408)
* **장애시 VIP 인계** ![failover.png](/files/1915147762258024795)

#### VIP 인계 예시 코드

``` bash
#!/bin/sh
healthcheck() {
  ping -c 1 -w 1 $VIP > /dev/null
}

ip_takeover() {
  ip addr add $VIP/24 dev eth0
  # send gratuitous arp
  send_arp $VIP $MAC 255.255.255.255 ffffffffffff
}

while healthcehck; do
  echo "alive"
done

echo "dead"
ip_takeover
```

### C. 장애검출

정상적인 장애극복을 위해 현재 운용장비에서 장애가 발생했음을 검출하는 방법 (헬스체크)

* ICMP 감시 (L3)
    * ICMP echo 요청으로 응답이 돌아오는지 확인.
    * 네트워크 통신이 가능한지 여부만 확인 가능
* 포트 감시 (L4)
    * TCP 접속 시험을 확인.
    * 해당 포트가 정상적으로 오픈되어있는지 확인 가능
* 서비스 감시 (L7)
    * 실제 서비스 요청을 보내 응답 확인
    * 서비스의 정상동작 유무 확인 가능

## 2\. 부하분산

### A. DNS 라운드로빈

하나의 도메인에 여러 공인 IP를 연결하여 부하를 분산하는 방법

![DNSfigure (1).gif](/files/1915186362047696606)

#### 특징

* 서버 수 만큼 글로벌 주소 필요
* 요청이 균등하게 분산되지 않음
    * DNS 캐시
* 서버 장애를 감지하지 못함
    * 서버 다운 혹은 과부하 상태를 감지할 수 없어, 해당 서버로 계속 요청을 보낸다

#### 구성 예

* **VIP를 이용한 DNS RR 구성** ![dnsrr_normal (1).png](/files/1915187538246459283)
* **장애시 VIP 인계** ![dnsrr_failover.png](/files/1915187579769296957)

### B. 로드밸런서

* DNS RR과의 차이점
    * 하나의 IP주소에 대해 요청을 복수의 서버로 분산할 수 있다.
    * 로드밸런서 사용 시, DNS RR보다 공인 IP 절약 가능

#### 로드밸런서 종류

* L4 스위치
    * IP / PORT 에 따라 분산 대상 서버 지정
    * DSR 구성으로 좀 더 나은 성능 추구 가능
* L7 스위치
    * 요청 URL에 대해 분산 대상 서버 지정
    * 분산 대상 서버 지정에 다양하고 유연한 설정 가능
        * 예) 정적파일 요청의 경우, 정적파일 전용 웹서버로 전송
* IPVS / keepalived
    * IPVS : 가상서버 정의 및 리얼서버 할당, 통계 정보 등.
    * keepalived : 설정파일에 따라 IPVS 가상서버 구축. 헬스채크, 로드밸런스 기능 수행

#### 스케줄링 알고리즘

| 명칭 | 동작 |
| --- | --- |
| Round Robin | 모든 서버를 처음부터 순서대로 선택. 균등하게 처리 분산 |
| Weighted Round Robin | 서버마다 가중치 부여. 가충지 별 분산 비율 선택 |
| Least Connection | 접속수가 가장 적은 서버 선택. 가장 무난하게 선택가능 |
| Weighted Least Connection | (접속수 + 1) / 가중치 가 최소가 되는 서버를 선택 |

#### VRRP를 이용한 로드밸런서 다중화

* 로드밸런서를 통해 웹 서버들의 다중화와 부하분산은 구현되었다.
* 하지만, 한 대뿐인 로드밸런서에 장애가 나면 전체 서비스에 장애를 가져온다.
* 라우터/로드밸런서의 다중화 기능을 지원하는 다중화 프로토콜 VRRP(Vritual Router Redundancy Protocol)을 이용해 다중화한다.
    * Active / Backup 구성 후, Active 장애 시 VIP와 가상 MAC주소를 Backup 에 인계